<?xml version="1.0" encoding="UTF-8"?>
<cursor xmlns="http://bio4j.ru/biodef-repo/store"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://bio4j.ru/biodef-repo/store http://bio4j.ru/biodef-repo/store/store-v10.xsd"
        multiselection="true">
    <SQL action="select">
        <text><![CDATA[
SELECT
  a.aterminalid,
  a.aterminalkey,
  a.ip4addr,
  (case a.tstate
	when 0 then 'Неопределенно'
	when 1 then 'Завершение работы'
	when 2 then 'Нормальная работа'
	when 3 then 'Предупреждение'
	when 4 then 'Ограничение функционала'
	when 5 then 'Нарушение функционирования'
	else 'Неизвестно'
   end) tstate,
  coalesce(a.aname_admin, a.aname) aname,
  coalesce(a.anote_admin, a.anote) anote,
  coalesce(a.addr_admin, a.addr) addr,
  a.cmdcur,
  (case a.cmdcur
	when 'p' then 'Play'
	when 's' then 'Stop'
	when 'o' then 'Off'
   end) cmdcur_desc,
  a.latitude,
  a.longitude,
  m.cmdtype cmdwaiting,
  (case m.cmdtype
	when 'p' then 'Play'
	when 's' then 'Stop'
	when 'o' then 'Off'
   end) cmdwaiting_desc,
   a.lastquery,
   l.errnote
FROM aterminal a
	LEFT JOIN (
		select * from (
		select a.*,
			row_number() over (partition by a.aterminalid order by a.registred desc, a.scrcmdid desc) rnum
		  from SCRCMD a) as o
		where o.rnum = 1
	) m on m.aterminalid = a.aterminalid
	LEFT JOIN (
		select * from (
		select a.*,
			row_number() over (partition by a.aterminalid order by a.created desc, a.recid desc) rnum
		  from ATERMINALLOG a) as o
		where o.rnum = 1
	) l on l.aterminalid = a.aterminalid
WHERE not isdeleted

        ]]></text>
    </SQL>
    <SQL action="update"><text>aterminal_edit</text></SQL>
    <SQL action="execute"><text>aterminal_del</text></SQL>
    <fields>
        <field name="aterminalid" type="integer" header="ID" pk="true" format="0"/>
        <field name="aterminalkey" type="string" header="Уникальный ключ" align="left" width="40"/>

        <field name="ip4addr" type="string" header="IP адрес" align="left" width="100"/>
        <field name="tstate" type="string" header="Состояние" align="left" width="150"/>
        <field name="lastquery" type="date" header="Дата/Время\nсостояния" width="100" format="d.m.Y H:i:s"/>
        <field name="aname" type="string" header="Наименование" width="280"/>
        <field name="anote" type="string" header="Описание" width="280" showTooltip="true"/>
        <field name="addr" type="string" header="Расположение" width="150" showTooltip="true"/>
        <field name="cmdcur" type="string" hidden="true"/>
        <field name="cmdcur_desc" type="string" header="Текущий режим" width="150"/>
        <field name="cmdwaiting_desc" type="string" header="Ожидается режим" width="150"/>
        <field name="errnote" type="string" header="Сообщение" width="150" showTooltip="true"/>
  </fields>
</cursor>
